<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">


<html>

<head>
    <link rel="stylesheet" href="/css/layout.css">
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
    <title>Quoilam's blog</title>

    <div class="banner">
        <a id="quoilam-logo" class="main-text" href="/">quoilam</a>
    </div>

    <div class="tags-wrapper">
        <div class="tags">
            <span>tags: </span>
            
                <span class="tag">
                    <a href="/tags/k8s/">
                        k8s
                    </a>
                </span>
                
                <span class="tag">
                    <a href="/tags/ph1/">
                        ph1
                    </a>
                </span>
                
                <span class="tag">
                    <a href="/tags/ph2/">
                        ph2
                    </a>
                </span>
                
        </div>
    </div>
    <script src="/js/prism.js"></script>
<link rel="stylesheet" href="/css/prism.css">

<link rel="stylesheet" href="/css/post.css">
<title>k8s初探 1 安装与启动集群</title>

<article class="post">
  <h1 class="title">k8s初探 1 安装与启动集群</h1>
  <div class="date">
    Sun Jul 27 2025 02:36:58 GMT+0800
  </div>
  <p>k8s初探系列文章，主要是记录学习k8s的过程和一些个人的理解。</p>
<p>ps. 使用 <code>fish</code>  <code>podman</code></p>
<h3 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h3><p>使用轻量化的k3s作为k8s的学习环境.<br>官方提供了镜像rancher&#x2F;k3s, 使用官方镜像构建一主两从的cluster.</p>
<h3 id="2-相关文件与脚本"><a href="#2-相关文件与脚本" class="headerlink" title="2. 相关文件与脚本"></a>2. 相关文件与脚本</h3><ul>
<li><p>2.1 容器compose文件<br>  参考 <a target="_blank" rel="noopener" href="https://docs.k3s.io/zh/advanced#%E5%9C%A8-docker-%E4%B8%AD%E8%BF%90%E8%A1%8C-k3s">官方文档</a> , 有少许改动</p>
  <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"># master.yml
services:
k3s-master:
    image: rancher&#x2F;k3s:v1.24.10-k3s1
    container_name: k3s-master
    command: 
    - server
    privileged: true
    ports:
    - &quot;6443:6443&quot;
    networks:
    - k3s-network

networks:
k3s-network:
    driver: bridge
</code></pre>

  <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"># worker.yml
services:
k3s-worker1:
    image: rancher&#x2F;k3s:v1.24.10-k3s1
    container_name: k3s-worker1
    command: 
    - agent
    - --server
    - https:&#x2F;&#x2F;k3s-master:6443
    - --token
    - $&#123;NODE_TOKEN&#125;
    privileged: true
    networks:
    - k3s-network

networks:
k3s-network:
    driver: bridge</code></pre>
<p>  ps.</p>
<ul>
<li>官方镜像不维护latest, 这里的版本号随便选的</li>
<li>worker的token需要从master容器中获取, 后面会设置环境变量</li>
</ul>
</li>
<li><p>2.2 安装kubectl</p>
  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew install kubectl</code></pre></li>
<li><p>2.3 启动集群<br>写了一个运行脚本, 用于启动k3s集群</p>
  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># start.sh

#!&#x2F;path&#x2F;to&#x2F;fish
function ensure_token_exists
    while not test -f &quot;.&#x2F;node-token&quot;
        sleep 1
        docker cp k3s-master:&#x2F;var&#x2F;lib&#x2F;rancher&#x2F;k3s&#x2F;server&#x2F;node-token .&#x2F;node-token
    end
end
docker compose -f master.yml up -d # 启动master容器
ensure_token_exists # 等待 node-token 文件生成, 拷贝出来
set -x NODE_TOKEN (cat .&#x2F;node-token) # 读取 node-token 文件内容
docker compose -f worker.yml up -d # 确保token存在后启动worker容器 
docker cp k3s-master:&#x2F;etc&#x2F;rancher&#x2F;k3s&#x2F;k3s.yaml .&#x2F;kubeconfig # 拷贝kubeconfig文件
alias kubectl&#x3D;&quot;kubectl --kubeconfig&#x3D;.&#x2F;kubeconfig&quot; # 设置kubectl命令</code></pre>
<p>  这里有几点备注一下</p>
<ul>
<li>必须确保 <code>master</code> 容器先启动, 因为 <code>worker</code> 容器需要从 <code>master</code> 获取 <code>node-token</code></li>
<li>已经将 <code>kubeconfig</code> 文件拷贝出来, 后续使用 <code>kubectl</code> 命令只需要指定 <code>--kubeconfig</code> 参数即可在宿主机上运行</li>
</ul>
</li>
<li><p>2.4 结束容器<br>  如果需要结束容器</p>
  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># end.sh
docker compose -f worker.yml down &amp;&amp; docker compose -f master.yml down
sudo rm -rf node-token
sudo rm -rf kubeconfig</code></pre></li>
</ul>
<h3 id="3-启动cluster"><a href="#3-启动cluster" class="headerlink" title="3. 启动cluster"></a>3. 启动cluster</h3><p>启动集群</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;start.sh</code></pre>
<p>检查container启动状态  </p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker ps -a | grep k3s </code></pre>

<p>检查cluster启动状态  </p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 宿主机上运行
kubectl get nodes  </code></pre>


<p>output will like this if everything is going well  </p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">NAME           STATUS   ROLES                  AGE   VERSION
83cd8546a4a1   Ready    control-plane,master   15s   v1.24.10+k3s1
326b286f1adb   Ready    &lt;none&gt;                 11s   v1.24.10+k3s1
b0cfc9d0326f   Ready    &lt;none&gt;                 10s   v1.24.10+k3s1</code></pre>
</article>
<div class="post-bottom"> END </div>
</body>

</html>